# Document Upload System Implementation

## Overview
This document describes the secure document upload system implemented for ESTA Tracker, allowing employees to upload doctor's notes and medical documentation for PTO requests.

## Architecture

### Storage Hierarchy
Documents are stored in Cloud Storage using the following path structure:
```
tenants/
  {tenantId}/
    employees/
      {employeeId}/
        documents/
          {requestId}/
            {timestamp}_{fileName}
```

This hierarchy provides:
- Clear tenant isolation
- Easy employee-level organization
- Request-specific document grouping
- Timestamp-based uniqueness

### Security Model

#### Access Control
1. **Upload Permissions**: Only employees can upload documents to their own folders
2. **Read Permissions**: Employees can read their own documents; employers can read all documents in their tenant
3. **Delete Permissions**: Only employers can delete documents, and only if not marked immutable
4. **Immutability**: Documents become read-only once the associated PTO request is approved

#### Authentication Flow
- All operations require Firebase Authentication
- Cloud Functions validate user identity and ownership
- Firestore custom claims used for role-based access (employee vs employer)

#### Signed URLs
- **Upload URLs**: 15-minute validity, allows direct upload to Cloud Storage
- **Download URLs**: 5-minute validity, provides temporary access for viewing
- URLs are generated by Cloud Functions after authorization checks

### Components

#### Cloud Functions (functions/src/index.ts)

1. **generateDocumentUploadUrl**
   - Validates user ownership of PTO request
   - Checks that request is not already approved
   - Generates signed upload URL
   - Creates document metadata in Firestore
   - Logs the action in audit trail

2. **confirmDocumentUpload**
   - Updates document status from 'pending' to 'uploaded'
   - Links document to PTO request
   - Records upload timestamp
   - Logs confirmation event

3. **getDocumentDownloadUrl**
   - Validates user has permission to access document
   - Generates signed download URL
   - Logs every document access
   - Updates access count and timestamp

4. **onPtoApproval** (Firestore Trigger)
   - Automatically fires when PTO status changes to 'approved'
   - Marks all associated documents as immutable
   - Updates storage file metadata
   - Creates audit log entry

#### Backend Routes (packages/backend/src/routes/documents.ts)

REST API endpoints for document management:
- `GET /api/v1/documents/request/:requestId` - List documents for a request
- `GET /api/v1/documents/:documentId` - Get document details
- `POST /api/v1/documents/upload-url` - Request signed upload URL
- `POST /api/v1/documents/:documentId/confirm` - Confirm upload
- `DELETE /api/v1/documents/:documentId` - Delete document (if not immutable)
- `GET /api/v1/documents/:documentId/access-logs` - View access history

#### Frontend Service (packages/frontend/src/lib/documentService.ts)

Client-side utilities for document operations:
- `uploadDocument()` - Complete upload flow (generate → upload → confirm)
- `downloadDocument()` - Retrieve and download document
- `validateDocumentFile()` - Client-side validation (type, size)
- `formatFileSize()` - Display formatting helper

### Data Models

#### Firestore Documents Collection
```typescript
{
  id: string
  requestId: string
  userId: string
  tenantId: string
  fileName: string
  originalFileName: string
  storagePath: string
  contentType: string
  status: 'pending' | 'uploaded' | 'failed'
  uploadedAt: Date | null
  createdAt: Date
  immutable?: boolean
  approvedAt?: Date
  accessCount?: number
  lastAccessedAt?: Date
  lastAccessedBy?: string
}
```

#### SickTimeRequest Updates
Added fields:
- `hasDocuments: boolean` - Quick check for document existence
- `documentIds: string[]` - Array of document IDs

### Audit Logging

All document operations are logged to the `auditLogs` collection:

1. **document_upload_url_generated** - When signed URL is created
2. **document_upload_confirmed** - When upload is confirmed
3. **document_accessed** - Every time a document is viewed/downloaded
4. **documents_marked_immutable** - When PTO is approved

Audit logs include:
- User ID
- Tenant/Employer ID
- Timestamp
- Action details (document ID, request ID, file name)
- Accessor role (for access logs)

### File Restrictions

#### Allowed Types
- `image/jpeg`
- `image/jpg`
- `image/png`
- `application/pdf`

#### Size Limits
- Maximum: 10 MB per file
- Enforced at client validation
- Enforced at storage rules level
- Enforced at Cloud Function level

### Immutability Implementation

Documents become immutable when:
1. PTO request status changes to 'approved'
2. Firestore trigger (`onPtoApproval`) fires
3. All documents for that request updated:
   - Firestore: `immutable: true` field set
   - Storage: `approved: 'true'` metadata added
4. Storage rules prevent further modifications
5. Cloud Functions reject operations on immutable documents

### Error Handling

#### Client-Side
- File validation before upload attempt
- Progress tracking for user feedback
- Error messages for network failures
- Retry logic for transient failures

#### Server-Side
- Comprehensive input validation
- Ownership verification
- Status checks (approved/not approved)
- Graceful error responses with appropriate HTTP codes

### Testing

Test coverage includes:
- File validation (type, size)
- File size formatting
- All tests passing (25 total in suite)
- Manual testing recommended for:
  - Upload flow with real Firebase project
  - Signed URL expiration
  - Immutability enforcement
  - Audit log accuracy

### Security Considerations

1. **No Direct Storage Access**: All operations use time-limited signed URLs
2. **Tenant Isolation**: Storage rules and Firestore rules enforce separation
3. **Immutability**: Once approved, documents cannot be modified or deleted
4. **Complete Audit Trail**: All access logged for compliance
5. **File Type Restrictions**: Only medical document types allowed
6. **Size Limits**: Prevents abuse and excessive storage costs

### Future Enhancements

Potential improvements:
1. Virus scanning for uploaded files
2. OCR processing for document text extraction
3. Document preview generation (thumbnails)
4. Bulk download for employers
5. Document expiration policies
6. Enhanced search and filtering
7. Document versioning (if immutability rules change)

## Deployment Notes

### Prerequisites
- Firebase project with Blaze plan (required for Cloud Functions)
- Cloud Storage enabled
- Firestore database configured
- Authentication enabled

### Configuration Steps
1. Deploy Firestore rules: `firebase deploy --only firestore:rules`
2. Deploy Storage rules: `firebase deploy --only storage`
3. Deploy Cloud Functions: `cd functions && npm run deploy`
4. Update environment variables with Firebase config
5. Test upload flow with staging environment first

### Monitoring
Monitor the following:
- Cloud Function execution times
- Storage bucket usage
- Failed upload attempts
- Audit log volume
- Signed URL generation rate

## Compliance

This implementation supports:
- Michigan ESTA recordkeeping requirements
- 3-year document retention (via immutability)
- Audit trail for compliance verification
- Secure handling of medical information
- Employee privacy protection
