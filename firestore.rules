rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // FIXED: Check role from Firestore document instead of custom claims
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function isRole(role) {
      return isAuthenticated() && getUserData().role == role;
    }
    
    function belongsToTenant(tenantId) {
      return isAuthenticated() && getUserData().tenantId == tenantId;
    }
    
    function isEmployer() {
      return isAuthenticated() && (getUserData().role == 'employer' || getUserData().role == 'admin');
    }
    
    function isEmployee() {
      return isAuthenticated() && getUserData().role == 'employee';
    }
    
    function belongsToEmployer(employerId) {
      return isAuthenticated() && getUserData().employerId == employerId;
    }
    
    // Employer Profiles collection
    match /employerProfiles/{employerId} {
      // Allow employer to create their own profile during registration
      allow create: if isAuthenticated() && request.auth.uid == employerId;
      
      // Employer can read/update their own profile
      allow read, update: if isAuthenticated() && request.auth.uid == employerId;
      
      // Employees can read their employer's profile (for branding)
      allow read: if isAuthenticated() && belongsToEmployer(employerId);
      
      // No one can delete employer profiles
      allow delete: if false;
      
      // Employee subcollection within employer profile
      match /employees/{employeeUid} {
        // Employer can read all employees under their profile
        allow read: if isAuthenticated() && request.auth.uid == employerId;
        
        // Employee can read their own record
        allow read: if isAuthenticated() && request.auth.uid == employeeUid;
        
        // Employer can create/update employee records
        allow create, update: if isAuthenticated() && request.auth.uid == employerId;
        
        // No deletion of employee records
        allow delete: if false;
      }
    }
    
    // Users collection
    match /users/{userId} {
      // FIXED: Allow authenticated users to create their own document during registration
      allow create: if isAuthenticated() && request.auth.uid == userId;
      
      // Users can read their own document
      allow read: if isOwner(userId);
      
      // Users can update their own document (limited fields)
      allow update: if isOwner(userId) && 
        !request.resource.data.diff(resource.data).affectedKeys()
          .hasAny(['role', 'tenantId', 'employerId', 'status']);
      
      // Employers can read users in their tenant
      allow read: if isEmployer() && 
        belongsToTenant(resource.data.tenantId);
      
      // Employers can read employees linked to them
      allow read: if isEmployer() && 
        request.auth.uid == resource.data.employerId;
      
      // No one can delete user documents
      allow delete: if false;
    }
    
    // Tenants collection
    match /tenants/{tenantId} {
      // FIXED: Allow authenticated users to create tenant during registration
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
      
      // Tenant owner can read/update
      allow read, update: if isAuthenticated() && 
        resource.data.ownerId == request.auth.uid;
      
      // Employees can read their tenant
      allow read: if isAuthenticated() && belongsToTenant(tenantId);
      
      // No one can delete tenants
      allow delete: if false;
    }
    
    // Work logs
    match /workLogs/{logId} {
      // Employers can read all logs in their tenant
      allow read: if isEmployer() && 
        belongsToTenant(resource.data.employerId);
      
      // Employees can read their own logs
      allow read: if isEmployee() && 
        isOwner(resource.data.userId);
      
      // Only employers can create/update/delete logs
      allow create, update, delete: if isEmployer() && 
        belongsToTenant(request.resource.data.employerId);
    }
    
    // Sick time requests
    match /sickTimeRequests/{requestId} {
      // Employers can read all requests in their tenant
      allow read: if isEmployer() && 
        belongsToTenant(resource.data.employerId);
      
      // Employees can read their own requests
      allow read: if isEmployee() && 
        isOwner(resource.data.userId);
      
      // Employees can create requests for themselves
      allow create: if isEmployee() && 
        request.resource.data.userId == request.auth.uid &&
        belongsToTenant(request.resource.data.employerId);
      
      // Only employers can update (approve/deny) requests
      allow update: if isEmployer() && 
        belongsToTenant(resource.data.employerId);
      
      // No one can delete requests
      allow delete: if false;
    }
    
    // Audit logs (read-only for users)
    match /auditLogs/{logId} {
      // FIXED: Allow authenticated users to create audit logs during registration
      allow create: if isAuthenticated();
      
      // Employers can read logs for their tenant
      allow read: if isEmployer() && 
        belongsToTenant(resource.data.employerId);
      
      // Employees can read logs related to themselves
      allow read: if isEmployee() && 
        isOwner(resource.data.userId);
      
      // No updates or deletes allowed
      allow update, delete: if false;
    }
    
    // Retaliation reports
    match /retaliationReports/{reportId} {
      // Only employers and admins can read reports
      allow read: if isEmployer() && 
        belongsToTenant(resource.data.employerId);
      
      // Employees can create reports for their tenant
      allow create: if isEmployee() && 
        belongsToTenant(request.resource.data.employerId) &&
        request.resource.data.reporterId == request.auth.uid;
      
      // Only employers can update reports
      allow update: if isEmployer() && 
        belongsToTenant(resource.data.employerId);
      
      // No one can delete reports
      allow delete: if false;
    }
    
    // Documents/attachments metadata
    match /documents/{documentId} {
      // Employers can read all documents in their tenant
      allow read: if isEmployer() && 
        belongsToTenant(resource.data.tenantId);
      
      // Employees can read their own documents
      allow read: if isEmployee() && 
        isOwner(resource.data.userId);
      
      // Employees can create documents for their own requests
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid &&
        belongsToTenant(request.resource.data.tenantId);
      
      // Documents can be updated by the owner if not marked immutable
      allow update: if isAuthenticated() && 
        isOwner(resource.data.userId) &&
        (!('immutable' in resource.data) || resource.data.immutable == false);
      
      // Only employers can delete documents, and only if not immutable
      allow delete: if isEmployer() && 
        belongsToTenant(resource.data.tenantId) &&
        (!('immutable' in resource.data) || resource.data.immutable == false);
    }
    
    // Default: deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
