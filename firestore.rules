rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isRole(role) {
      return isAuthenticated() && 
        (request.auth.token.role == role || 
         (request.auth.token.role == null && resource != null && resource.data.role == role));
    }
    
    function belongsToTenant(tenantId) {
      return isAuthenticated() && 
        (request.auth.token.tenantId == tenantId ||
         request.auth.token.employerId == tenantId ||
         (request.auth.token.tenantId == null && resource != null && resource.data.tenantId == tenantId));
    }
    
    function isEmployer() {
      return isRole('employer') || isRole('admin');
    }
    
    function isEmployee() {
      return isRole('employee');
    }
    
    // Users collection
    match /users/{userId} {
      // Users can read their own document
      allow read: if isOwner(userId);
      
      // Users can update their own document (limited fields)
      allow update: if isOwner(userId) && 
        !request.resource.data.diff(resource.data).affectedKeys()
          .hasAny(['role', 'tenantId', 'employerId', 'status']);
      
      // Employers can read users in their tenant
      allow read: if isEmployer() && 
        belongsToTenant(resource.data.tenantId);
      
      // Allow authenticated users to create their own user document on first registration
      // Validates: correct UID, required fields, email matches auth email, document doesn't exist
      allow create: if isAuthenticated() 
        && request.auth.uid == userId
        && request.resource.data.keys().hasAll(['email', 'name', 'role'])
        && request.resource.data.email == request.auth.token.email
        && !exists(/databases/$(database)/documents/users/$(userId))
        && request.resource.data.role in ['employer', 'employee'];
      
      allow delete: if false;
    }
    
    // Tenants collection
    match /tenants/{tenantId} {
      // Tenant owner can read/update
      allow read, update: if isAuthenticated() && 
        resource.data.ownerId == request.auth.uid;
      
      // Employees can read their tenant
      allow read: if belongsToTenant(tenantId);
      
      // Allow authenticated users to create tenant during employer registration
      // Validates: correct ownerId, required fields
      allow create: if isAuthenticated()
        && request.resource.data.ownerId == request.auth.uid
        && request.resource.data.keys().hasAll(['companyName', 'tenantCode', 'size', 'ownerId'])
        && !exists(/databases/$(database)/documents/tenants/$(tenantId));
      
      allow delete: if false;
    }
    
    // Work logs
    match /workLogs/{logId} {
      // Employers can read all logs in their tenant
      allow read: if isEmployer() && 
        belongsToTenant(resource.data.employerId);
      
      // Employees can read their own logs
      allow read: if isEmployee() && 
        isOwner(resource.data.userId);
      
      // Only employers can create/update/delete logs
      allow create, update, delete: if isEmployer() && 
        belongsToTenant(resource.data.employerId);
    }
    
    // Sick time requests
    match /sickTimeRequests/{requestId} {
      // Employers can read all requests in their tenant
      allow read: if isEmployer() && 
        belongsToTenant(resource.data.employerId);
      
      // Employees can read their own requests
      allow read: if isEmployee() && 
        isOwner(resource.data.userId);
      
      // Employees can create requests for themselves
      allow create: if isEmployee() && 
        request.resource.data.userId == request.auth.uid &&
        belongsToTenant(request.resource.data.employerId);
      
      // Only employers can update (approve/deny) requests
      allow update: if isEmployer() && 
        belongsToTenant(resource.data.employerId);
      
      // No one can delete requests
      allow delete: if false;
    }
    
    // Audit logs (read-only for users)
    match /auditLogs/{logId} {
      // Employers can read logs for their tenant
      allow read: if isEmployer() && 
        belongsToTenant(resource.data.employerId);
      
      // Employees can read logs related to themselves
      allow read: if isEmployee() && 
        isOwner(resource.data.userId);
      
      // Only system can write audit logs
      allow write: if false;
    }
    
    // Retaliation reports
    match /retaliationReports/{reportId} {
      // Only employers and admins can read reports
      allow read: if isEmployer() && 
        belongsToTenant(resource.data.employerId);
      
      // Employees can create reports for their tenant
      allow create: if isEmployee() && 
        belongsToTenant(request.resource.data.employerId) &&
        request.resource.data.reporterId == request.auth.uid;
      
      // Only employers can update reports
      allow update: if isEmployer() && 
        belongsToTenant(resource.data.employerId);
      
      // No one can delete reports
      allow delete: if false;
    }
    
    // Documents/attachments metadata
    match /documents/{documentId} {
      // Employers can read all documents in their tenant
      allow read: if isEmployer() && 
        belongsToTenant(resource.data.tenantId);
      
      // Employees can read their own documents
      allow read: if isEmployee() && 
        isOwner(resource.data.userId);
      
      // Employees can create documents for their own requests
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid &&
        belongsToTenant(request.resource.data.tenantId);
      
      // Documents can be updated by the owner if not marked immutable
      allow update: if isAuthenticated() && 
        isOwner(resource.data.userId) &&
        (!('immutable' in resource.data) || resource.data.immutable == false);
      
      // Only employers can delete documents, and only if not immutable
      allow delete: if isEmployer() && 
        belongsToTenant(resource.data.tenantId) &&
        (!('immutable' in resource.data) || resource.data.immutable == false);
    }
    
    // Default: deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
